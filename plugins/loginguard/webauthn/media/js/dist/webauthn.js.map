{"version":3,"sources":["../webauthn.js"],"names":["akeeba","LoginGuard","webauthn","authData","arrayToBase64String","a","btoa","String","fromCharCode","base64url2base64","input","output","replace","pad","length","Error","Array","join","setUp","navigator","alert","Joomla","JText","_","console","log","rawPKData","document","forms","querySelectorAll","value","publicKey","JSON","parse","atob","challenge","Uint8Array","from","window","c","charCodeAt","user","id","excludeCredentials","map","data","credentials","create","then","publicKeyCredential","type","rawId","response","clientDataJSON","attestationObject","getElementById","stringify","submit","error","handle_error","message","$","show","e","validate","allowCredentials","get","authenticatorData","signature","userHandle","onValidateClick","event","preventDefault","getOptions","jQuery","hide","style","display","click"],"mappings":"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","sourcesContent":["/*\n * @package   AkeebaLoginGuard\n * @copyright Copyright (c)2016-2020 Nicholas K. Dionysopoulos / Akeeba Ltd\n * @license   GNU General Public License version 3, or later\n */\n\n// Namespace\nlet akeeba = akeeba || {};\n\nakeeba.LoginGuard = akeeba.LoginGuard || {};\n\nakeeba.LoginGuard.webauthn = akeeba.LoginGuard.webauthn || {\n    authData: null\n};\n\n/**\n * Utility function to convert array data to base64 strings\n */\nakeeba.LoginGuard.webauthn.arrayToBase64String = (a) =>\n{\n    return btoa(String.fromCharCode(...a));\n};\n\nakeeba.LoginGuard.webauthn.base64url2base64 = function(input) {\n    let output = input\n        .replace(/-/g, '+')\n        .replace(/_/g, '/');\n    const pad = output.length % 4;\n    if (pad) {\n        if (pad === 1) {\n            throw new Error('InvalidLengthError: Input base64url string is the wrong length to determine padding');\n        }\n        output += new Array(5 - pad).join('=');\n    }\n    return output;\n}\n\n/**\n * Ask the user to link an authenticator using the provided public key (created server-side).\n */\nakeeba.LoginGuard.webauthn.setUp = () =>\n{\n    // Make sure the browser supports Webauthn\n    if (!('credentials' in navigator))\n    {\n        alert(Joomla.JText._('PLG_LOGINGUARD_WEBAUTHN_ERR_NOTAVAILABLE_HEAD'));\n\n        console.log('This browser does not support Webauthn');\n\n        return;\n    }\n\n    const rawPKData = document.forms['loginguard-method-edit'].querySelectorAll('input[name=\"pkRequest\"]')[0].value;\n    const publicKey = JSON.parse(atob(rawPKData));\n\n    // Convert the public key infomration to a format usable by the browser's credentials managemer\n    publicKey.challenge = Uint8Array.from(\n        window.atob(akeeba.LoginGuard.webauthn.base64url2base64(publicKey.challenge)), (c) => c.charCodeAt(0),\n    );\n\n    publicKey.user.id = Uint8Array.from(window.atob(publicKey.user.id), (c) => c.charCodeAt(0));\n\n    if (publicKey.excludeCredentials) {\n        publicKey.excludeCredentials = publicKey.excludeCredentials.map((data) => {\n            data.id = Uint8Array.from(window.atob(akeeba.LoginGuard.webauthn.base64url2base64(data.id)), (c) => c.charCodeAt(0));\n            return data;\n        });\n    }\n\n    // Ask the browser to prompt the user for their authenticator\n    navigator.credentials.create({publicKey})\n        .then((data) => {\n            const publicKeyCredential = {\n                id:       data.id,\n                type:     data.type,\n                rawId:    akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.rawId)),\n                response: {\n                    clientDataJSON:    akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.response.clientDataJSON)),\n                    attestationObject: akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.response.attestationObject))\n                }\n            };\n\n            // Store the WebAuthn reply\n            document.getElementById('loginguard-method-code').value = btoa(JSON.stringify(publicKeyCredential));\n\n            // Submit the form\n            document.forms['loginguard-method-edit'].submit();\n        }, (error) => {\n            // An error occurred: timeout, request to provide the authenticator refused, hardware / software error...\n            akeeba.LoginGuard.webauthn.handle_error(error);\n        });\n};\n\nakeeba.LoginGuard.webauthn.handle_error = (message) =>\n{\n    try\n    {\n        $('#loginguard-webauthn-button').show();\n    }\n    catch (e) {};\n\n    alert(message);\n\n    console.log(message);\n};\n\nakeeba.LoginGuard.webauthn.validate = () =>\n{\n    // Make sure the browser supports Webauthn\n    if (!('credentials' in navigator))\n    {\n        alert(Joomla.JText._('PLG_LOGINGUARD_WEBAUTHN_ERR_NOTAVAILABLE_HEAD'));\n\n        console.log('This browser does not support Webauthn');\n\n        return;\n    }\n\n    const publicKey = akeeba.LoginGuard.webauthn.authData;\n\n    if (!publicKey.challenge)\n    {\n        akeeba.LoginGuard.webauthn.handle_error(Joomla.JText._('PLG_LOGINGUARD_WEBAUTHN_ERR_NO_STORED_CREDENTIAL'));\n\n        return;\n    }\n\n    publicKey.challenge = Uint8Array.from(\n        window.atob(akeeba.LoginGuard.webauthn.base64url2base64(publicKey.challenge)), (c) => c.charCodeAt(0),\n    );\n\n    if (publicKey.allowCredentials) {\n        publicKey.allowCredentials = publicKey.allowCredentials.map((data) => {\n            data.id = Uint8Array.from(window.atob(akeeba.LoginGuard.webauthn.base64url2base64(data.id)), (c) => c.charCodeAt(0));\n            return data;\n        });\n    }\n\n    navigator.credentials.get({publicKey})\n        .then(data => {\n            const publicKeyCredential = {\n                id:       data.id,\n                type:     data.type,\n                rawId:    akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.rawId)),\n                response: {\n                    authenticatorData: akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.response.authenticatorData)),\n                    clientDataJSON:    akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.response.clientDataJSON)),\n                    signature:         akeeba.LoginGuard.webauthn.arrayToBase64String(new Uint8Array(data.response.signature)),\n                    userHandle:        data.response.userHandle ? akeeba.LoginGuard.webauthn.arrayToBase64String(\n                        new Uint8Array(data.response.userHandle)) : null\n                }\n            };\n\n            document.getElementById('loginGuardCode').value = btoa(JSON.stringify(publicKeyCredential));\n            document.forms['loginguard-captive-form'].submit();\n        }, (error) => {\n            // Example: timeout, interaction refused...\n            console.log(error);\n            akeeba.LoginGuard.webauthn.handle_error(error);\n        });\n};\n\nakeeba.LoginGuard.webauthn.onValidateClick = function (event) {\n    event.preventDefault();\n\n    akeeba.LoginGuard.webauthn.authData = JSON.parse(window.atob(Joomla.getOptions('com_loginguard.authData')));\n\n    window.jQuery('#loginguard-webauthn-button').hide();\n    akeeba.LoginGuard.webauthn.validate();\n\n    return false;\n}\n\ndocument.getElementById('loginguard-webauthn-missing').style.display = 'none';\n\nif (typeof(navigator.credentials) == 'undefined')\n{\n    document.getElementById('loginguard-webauthn-missing').style.display = 'block';\n    document.getElementById('loginguard-webauthn-controls').style.display = 'none';\n}\n\nif (Joomla.getOptions('com_loginguard.pagetype') === 'validate')\n{\n    window.jQuery('#plg_loginguard_webauthn_validate_button').click(akeeba.LoginGuard.webauthn.onValidateClick);\n    window.jQuery('#loginguard-captive-button-submit').click(akeeba.LoginGuard.webauthn.onValidateClick);\n}\nelse\n{\n    window.jQuery('#plg_loginguard_webauthn_register_button').click(akeeba.LoginGuard.webauthn.setUp);\n}"],"file":"webauthn.js"}