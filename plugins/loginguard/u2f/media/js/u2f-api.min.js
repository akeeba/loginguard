/*
 Copyright 2014-2015 Google Inc. All rights reserved.

 Use of this source code is governed by a BSD-style
 license that can be found in the LICENSE file or at
 https://developers.google.com/open-source/licenses/bsd

 This file comes from the U2F API Polyfill retrieved from https://github.com/mastahyeti/u2f-api
*/
(function(){var l="chrome"in window&&0>window.navigator.userAgent.indexOf("Edge");if(!("u2f"in window)&&l){var a=window.u2f={},k;a.EXTENSION_ID="kmendfapggjehodndflmmgagdbamhnfd";a.MessageTypes={U2F_REGISTER_REQUEST:"u2f_register_request",U2F_REGISTER_RESPONSE:"u2f_register_response",U2F_SIGN_REQUEST:"u2f_sign_request",U2F_SIGN_RESPONSE:"u2f_sign_response",U2F_GET_API_VERSION_REQUEST:"u2f_get_api_version_request",U2F_GET_API_VERSION_RESPONSE:"u2f_get_api_version_response"};a.ErrorCodes={OK:0,OTHER_ERROR:1,
BAD_REQUEST:2,CONFIGURATION_UNSUPPORTED:3,DEVICE_INELIGIBLE:4,TIMEOUT:5};a.getMessagePort=function(b){"undefined"!=typeof chrome&&chrome.runtime?chrome.runtime.sendMessage(a.EXTENSION_ID,{type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:[]},function(){chrome.runtime.lastError?a.getIframePort_(b):a.getChromeRuntimePort_(b)}):a.isAndroidChrome_()?a.getAuthenticatorPort_(b):a.isIosChrome_()?a.getIosPort_(b):a.getIframePort_(b)};a.isAndroidChrome_=function(){var b=navigator.userAgent;return-1!=b.indexOf("Chrome")&&
-1!=b.indexOf("Android")};a.isIosChrome_=function(){return-1<["iPhone","iPad","iPod"].indexOf(navigator.platform)};a.getChromeRuntimePort_=function(b){var c=chrome.runtime.connect(a.EXTENSION_ID,{includeTlsChannelId:!0});setTimeout(function(){b(new a.WrappedChromeRuntimePort_(c))},0)};a.getAuthenticatorPort_=function(b){setTimeout(function(){b(new a.WrappedAuthenticatorPort_)},0)};a.getIosPort_=function(b){setTimeout(function(){b(new a.WrappedIosPort_)},0)};a.WrappedChromeRuntimePort_=function(b){this.port_=
b};a.formatSignRequest_=function(b,c,d,e,g){if(void 0===k||1.1>k){for(var f=[],h=0;h<d.length;h++)f[h]={version:d[h].version,challenge:c,keyHandle:d[h].keyHandle,appId:b};return{type:a.MessageTypes.U2F_SIGN_REQUEST,signRequests:f,timeoutSeconds:e,requestId:g}}return{type:a.MessageTypes.U2F_SIGN_REQUEST,appId:b,challenge:c,registeredKeys:d,timeoutSeconds:e,requestId:g}};a.formatRegisterRequest_=function(b,c,d,e,g){if(void 0===k||1.1>k){for(var f=0;f<d.length;f++)d[f].appId=b;var h=[];for(f=0;f<c.length;f++)h[f]=
{version:c[f].version,challenge:d[0],keyHandle:c[f].keyHandle,appId:b};return{type:a.MessageTypes.U2F_REGISTER_REQUEST,signRequests:h,registerRequests:d,timeoutSeconds:e,requestId:g}}return{type:a.MessageTypes.U2F_REGISTER_REQUEST,appId:b,registerRequests:d,registeredKeys:c,timeoutSeconds:e,requestId:g}};a.WrappedChromeRuntimePort_.prototype.postMessage=function(b){this.port_.postMessage(b)};a.WrappedChromeRuntimePort_.prototype.addEventListener=function(b,c){b=b.toLowerCase();"message"==b||"onmessage"==
b?this.port_.onMessage.addListener(function(d){c({data:d})}):console.error("WrappedChromeRuntimePort only supports onMessage")};a.WrappedAuthenticatorPort_=function(){this.requestId_=-1;this.requestObject_=null};a.WrappedAuthenticatorPort_.prototype.postMessage=function(b){b=a.WrappedAuthenticatorPort_.INTENT_URL_BASE_+";S.request="+encodeURIComponent(JSON.stringify(b))+";end";document.location=b};a.WrappedAuthenticatorPort_.prototype.getPortType=function(){return"WrappedAuthenticatorPort_"};a.WrappedAuthenticatorPort_.prototype.addEventListener=
function(b,c){"message"==b.toLowerCase()?window.addEventListener("message",this.onRequestUpdate_.bind(this,c),!1):console.error("WrappedAuthenticatorPort only supports message")};a.WrappedAuthenticatorPort_.prototype.onRequestUpdate_=function(b,c){c=JSON.parse(c.data);var d=null;c.hasOwnProperty("data")&&(d=JSON.parse(c.data));b({data:d})};a.WrappedAuthenticatorPort_.INTENT_URL_BASE_="intent:#Intent;action=com.google.android.apps.authenticator.AUTHENTICATE";a.WrappedIosPort_=function(){};a.WrappedIosPort_.prototype.postMessage=
function(b){b=JSON.stringify(b);b="u2f://auth?"+encodeURI(b);location.replace(b)};a.WrappedIosPort_.prototype.getPortType=function(){return"WrappedIosPort_"};a.WrappedIosPort_.prototype.addEventListener=function(b,c){"message"!==b.toLowerCase()&&console.error("WrappedIosPort only supports message")};a.getIframePort_=function(b){var c="chrome-extension://"+a.EXTENSION_ID,d=document.createElement("iframe");d.src=c+"/u2f-comms.html";d.setAttribute("style","display:none");document.body.appendChild(d);
var e=new MessageChannel,g=function(f){"ready"==f.data?(e.port1.removeEventListener("message",g),b(e.port1)):console.error('First event on iframe port was not "ready"')};e.port1.addEventListener("message",g);e.port1.start();d.addEventListener("load",function(){d.contentWindow.postMessage("init",c,[e.port2])})};a.EXTENSION_TIMEOUT_SEC=30;a.port_=null;a.waitingForPort_=[];a.reqCounter_=0;a.callbackMap_={};a.getPortSingleton_=function(b){a.port_?b(a.port_):(0==a.waitingForPort_.length&&a.getMessagePort(function(c){a.port_=
c;for(a.port_.addEventListener("message",a.responseHandler_);a.waitingForPort_.length;)a.waitingForPort_.shift()(a.port_)}),a.waitingForPort_.push(b))};a.responseHandler_=function(b){b=b.data;var c=b.requestId;if(c&&a.callbackMap_[c]){var d=a.callbackMap_[c];delete a.callbackMap_[c];d(b.responseData)}else console.error("Unknown or missing requestId in response.")};a.sign=function(b,c,d,e,g){void 0===k?a.getApiVersion(function(f){k=void 0===f.js_api_version?0:f.js_api_version;console.log("Extension JS API Version: ",
k);a.sendSignRequest(b,c,d,e,g)}):a.sendSignRequest(b,c,d,e,g)};a.sendSignRequest=function(b,c,d,e,g){a.getPortSingleton_(function(f){var h=++a.reqCounter_;a.callbackMap_[h]=e;h=a.formatSignRequest_(b,c,d,"undefined"!==typeof g?g:a.EXTENSION_TIMEOUT_SEC,h);f.postMessage(h)})};a.register=function(b,c,d,e,g){void 0===k?a.getApiVersion(function(f){k=void 0===f.js_api_version?0:f.js_api_version;console.log("Extension JS API Version: ",k);a.sendRegisterRequest(b,c,d,e,g)}):a.sendRegisterRequest(b,c,d,
e,g)};a.sendRegisterRequest=function(b,c,d,e,g){a.getPortSingleton_(function(f){var h=++a.reqCounter_;a.callbackMap_[h]=e;h=a.formatRegisterRequest_(b,d,c,"undefined"!==typeof g?g:a.EXTENSION_TIMEOUT_SEC,h);f.postMessage(h)})};a.getApiVersion=function(b,c){a.getPortSingleton_(function(d){if(d.getPortType){switch(d.getPortType()){case "WrappedIosPort_":case "WrappedAuthenticatorPort_":d=1.1;break;default:d=0}b({js_api_version:d})}else{var e=++a.reqCounter_;a.callbackMap_[e]=b;d.postMessage({type:a.MessageTypes.U2F_GET_API_VERSION_REQUEST,
timeoutSeconds:"undefined"!==typeof c?c:a.EXTENSION_TIMEOUT_SEC,requestId:e})}})}}})();
